<!DOCTYPE html>
<html>

<head>
    <title>Lethal Company Cams UI</title>
    <script type="text/javascript">
        document.addEventListener('DOMContentLoaded', () => {
            const MAX_PLAYERS = 12;
            const IGNORE_PREFIX = "IGNOREDPLAYER:";

            const INITIAL_PLAYERS = ["Old Yeller", "Murmuring"]; // for future, cache player names
            const HOTKEYS = ["F5", "F6", "F7", "F8"]; // for future, assign keys and generate custom AHK script
            const SWAPPER_SCRIPT = `#Requires AutoHotkey v2.0
#MaxThreads 1
/*
For use in Lethal Company. Allows for fast switching between players in the terminal.
Reads list of players from the clipboard. Intended for use with a companion UI.

Hot keys
    = and middle mouse button will toggle the map view on and off in the terminal
    Several ways to cycle through players:
        [ and ]
        The side mouse buttons
        Scroll wheel left and right
    F5-F8 will jump to the first 4 players, respectively.
*/

; Global vars
curr_player_index := 1

/*
Functions
*/
SendCommand(command)
{
	Send command
	Send "{Enter}"
    sleep 50
    return
}

AllowCycleToPlayer(name)
{
    return name != "" and !RegExMatch(name, "^IGNOREDPLAYER:")
}

AllowJumpToPlayer(name)
{
    return name != ""
}

RemovePrefixFromName(name)
{
    return RegExMatch(name, "^IGNOREDPLAYER:")
    ? SubStr(name, 15)
    : name
}

SwitchToPlayer(name)
{
    name := Trim(name)
    if AllowJumpToPlayer(name) {
        SendCommand("switch " . RemovePrefixFromName(name))
    }
}

SwitchToIndex(index)
{
    global curr_player_index
    players := GetPlayers()
    try {
        SwitchToPlayer(players[index])
        curr_player_index := index
    }
}

IsPlayerListValid(players)
{
    Loop players.length {
        if Trim(players[A_Index]){
            return true
        }
    }
    return false
}

GetPlayers()
{
	text := RegExReplace(A_Clipboard, "\`r") ; pesky windows users
	players := StrSplit(text, "\`n")
    if (IsPlayerListValid(players) == false) {
        Throw "Your clipboard is empty! It should contain names separated by new lines."
    }
    return players
}

GetNextIndex(index, players)
{
    new_index := index + 1
    if (new_index > players.length) {
        new_index := 1
    }
    return new_index
}

GetNextPlayer()
{
    global curr_player_index
    search_count := 1

    players := GetPlayers()
    new_index := GetNextIndex(curr_player_index, players)
    while (!AllowCycleToPlayer(players[new_index]) and search_count < players.length) {
        new_index := GetNextIndex(new_index, players)
        search_count += 1
    }
    if curr_player_index == new_index {
        return ""
    }
    else {
        curr_player_index := new_index
        return players[curr_player_index]
    }
}

GetPrevIndex(index, players)
{
    new_index := index - 1
    if (new_index == 0) {
        new_index := players.length
    }
    return new_index
}

GetPrevPlayer()
{
    global curr_player_index
    search_count := 1

    players := GetPlayers()
    new_index := GetPrevIndex(curr_player_index, players)
    while (!AllowCycleToPlayer(players[new_index]) and search_count < players.length) {
        new_index := GetPrevIndex(new_index, players)
        search_count += 1
    }
    if curr_player_index == new_index {
        return ""
    }
    else {
        curr_player_index := new_index
        return players[curr_player_index]
    }
}

/*
Hot Keys
*/
; toggle map in terminal
$MButton::
$=::
{
    SendCommand("view monitor")
}

; cycle to prev player
$[::
$XButton1::
$WheelLeft::
{
    next_player := GetPrevPlayer()
    SwitchToPlayer(next_player)
    return
}

; cycle to next player
$]::
$XButton2::
$WheelRight::
{
    next_player := GetNextPlayer()
    SwitchToPlayer(next_player)
    return
}

; bind first four players to hotkeys
$F5::
{
    SwitchToIndex(1)
}
$F6::
{
    SwitchToIndex(2)
}
$F7::
{
    SwitchToIndex(3)
}
$F8::
{
    SwitchToIndex(4)
}
`;
            const getNameFieldId = (index) => {
                return `player${index}_name`;
            };

            const getCheckboxId = (index) => {
                return `player${index}_cb`;
            };

            const saveToClipboard = () => {
                const textToSave = Array.from({ length: MAX_PLAYERS }, (_, i) => {
                    const checkbox = document.getElementById(getCheckboxId(i));
                    const playerName = document.getElementById(getNameFieldId(i)).value.trim();
                    return playerName !== ''
                        ? checkbox.checked ? playerName : `${IGNORE_PREFIX}${playerName}`
                        : "";
                }).join("\n");

                navigator.clipboard.writeText(textToSave);
            };

            const setPlayerList = (name_array) => {
                for (i = 0; i < MAX_PLAYERS; i++) {
                    const new_name = name_array[i] ? name_array[i] : "";
                    document.getElementById(getNameFieldId(i)).value = new_name;
                }
            };

            const addColumnToRow = (row, column) => {
                const new_column = document.createElement('td');
                new_column.appendChild(column);
                row.appendChild(new_column);
            };

            const areAllRowsChecked = () => {
                return Array.from({ length: MAX_PLAYERS }, (_, i) => {
                    return document.getElementById(getCheckboxId(i)).checked;
                }).every((checked) => checked);
            };

            const handlePlayerListCheckbox = () => {
                saveToClipboard()
                checkbox_toggle_all = document.getElementById("cb_toggle_all");
                checkbox_toggle_all.checked = areAllRowsChecked();
            };

            const setUpList = () => {
                const list = document.getElementById("player_table_body");
                for (i = 0; i < MAX_PLAYERS; i++) {
                    const new_row = document.createElement('tr');

                    const ordinal = document.createElement('div');
                    ordinal.innerText = String(i + 1) + ".";

                    const checkbox = document.createElement('input');
                    checkbox.id = getCheckboxId(i);
                    checkbox.type = "checkbox";
                    checkbox.title = "Check to include in camera view.";
                    checkbox.checked = "true";
                    checkbox.addEventListener('change', handlePlayerListCheckbox);

                    const textbox = document.createElement('input');
                    textbox.id = getNameFieldId(i);
                    textbox.type = "text";
                    textbox.addEventListener('keyup', (event) => {
                        saveToClipboard();
                    });

                    const hotkeyDisplay = document.createElement('b');
                    hotkeyDisplay.innerText = HOTKEYS[i] ? HOTKEYS[i] : "";
                    hotkeyDisplay.title = "Hotkey for swapping to this player.";

                    addColumnToRow(new_row, ordinal);
                    addColumnToRow(new_row, checkbox);
                    addColumnToRow(new_row, textbox);
                    addColumnToRow(new_row, hotkeyDisplay);
                    list.appendChild(new_row);
                }
                setPlayerList(INITIAL_PLAYERS);
            };

            const setAllCheckboxes = (new_checked) => {
                for (i = 0; i < MAX_PLAYERS; i++) {
                    const checkbox = document.getElementById(getCheckboxId(i));
                    checkbox.checked = new_checked;
                };
                document.getElementById("cb_toggle_all").checked = new_checked;
            };

            const toggleAll = () => {
                const any_unchecked = !areAllRowsChecked();
                setAllCheckboxes(any_unchecked);
            };

            const clearPlayerList = () => {
                setPlayerList([]);
            };

            const setUpButtons = () => {
                document.getElementById("cb_toggle_all").addEventListener("click", toggleAll);
                document.getElementById("btn_clear_names").addEventListener("click", clearPlayerList);
                document.getElementById("btn_copy_to").addEventListener("click", saveToClipboard);
            };

            const setUpScriptDownload = () => {
                const dl_link = document.getElementById("script_download");
                const script_file = new Blob([SWAPPER_SCRIPT], { type: 'text/plain' });
                dl_link.download = "player_swapper.ahk";
                dl_link.href = window.URL.createObjectURL(script_file);
            };

            setUpList();
            setUpButtons();
            setUpScriptDownload();
            handlePlayerListCheckbox();
        });
    </script>
</head>

<body>
    <h3>Guy in Chair Controls</h3>
    <p>Updating any row automatically populates your clipboard.</p>
    <p>The AHK script (see Setup Instructions) will read names from your clipboard.</p>

    <div>
        <table id="player_list">
            <thead>
                <th>#</th>
                <th><input type="checkbox" id="cb_toggle_all" checked="true" title="Toggle All" /></th>
                <th>Names</th>
                <th>Key</th>
            </thead>
            <tbody id="player_table_body" />
        </table>
    </div>
    <button type="button" id="btn_copy_to">Copy to Clipboard</button>
    <button type="button" id="btn_clear_names">Clear All</button>

    <h4>Hotkeys</h4>
    <ul>
        <li>Toggle the map view on and off in the terminal.
            <ul>
                <li><b>=</b>
                <li>Middle mouse button
            </ul>
        </li>
        <li>To cycle through all checked players in order, use any of these:
            <ul>
                <li>[ and ]
                <li>Mouse side buttons (i.e. browser back and forward)
                <li>Mouse wheel left/right
            </ul>
        </li>
        <li>F5 through F8 are bound to the first four players, respectively.</li>
    </ul>

    </p>
    <h4>Setup Instructions</h4>
    <ol>
        <li>Download and install <a href="https://www.autohotkey.com/">AutoHotKey (v2)</a>.</li>
        <li>Download and run <a id="script_download" href="#">player_swapper.ahk</a>.</li>
        <li>Teleport your <s>friends</s> coworkers out if they are spinning.</li>
        <li>Stop the script with <i>right click > Exit</i> on the Green H icon in the system tray.</li>
    </ol>
    <footer>
        <p>Written™ by Ben® 2023©.</p>
    </footer>
</body>

</html>